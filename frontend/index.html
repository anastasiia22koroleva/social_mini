<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Social Mini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e5e7eb;
      color: #111827;
    }
    body {
      margin: 0;
      padding: 24px;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 1200px;
      width: 100%;
      display: grid;
      grid-template-columns: 1.0fr 1.6fr;
      gap: 20px;
    }
    @media (max-width: 960px) {
      body {
        padding: 12px;
      }
      .container {
        grid-template-columns: 1fr;
      }
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    .card {
      background: #f9fafb;
      border-radius: 18px;
      padding: 18px 20px 20px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    }
    .card + .card {
      margin-top: 16px;
    }
    label {
      font-size: 14px;
      display: block;
      margin-bottom: 4px;
      color: #4b5563;
    }
    input, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      margin-bottom: 10px;
      outline: none;
      background: #f9fafb;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }
    input:focus, textarea:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
      background: #ffffff;
    }
    textarea {
      min-height: 90px;
      resize: vertical;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #4f46e5;
      color: white;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, box-shadow 0.15s, transform 0.05s;
      white-space: nowrap;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button.danger {
      background: #ef4444;
    }
    button.small {
      padding: 4px 10px;
      font-size: 12px;
    }
    button:hover {
      background: #4338ca;
      box-shadow: 0 6px 18px rgba(79, 70, 229, 0.4);
      transform: translateY(-1px);
    }
    button.secondary:hover {
      background: #d1d5db;
      box-shadow: none;
      transform: none;
    }
    button.danger:hover {
      background: #b91c1c;
      box-shadow: 0 6px 18px rgba(248, 113, 113, 0.4);
    }
    button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .status {
      font-size: 13px;
      margin-top: 6px;
      min-height: 18px;
    }
    .status.ok {
      color: #15803d;
    }
    .status.err {
      color: #b91c1c;
    }
    .muted {
      font-size: 13px;
      color: #6b7280;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      background: #eef2ff;
      color: #3730a3;
      padding: 4px 10px;
      border-radius: 999px;
    }
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .posts-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .post-card {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      background: #ffffff;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
    }
    .post-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 15px;
    }
    .post-meta {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .post-content {
      font-size: 14px;
      white-space: pre-wrap;
      margin-bottom: 8px;
    }
    .post-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
    }
    .like-button {
      background: #eef2ff;
      color: #312e81;
    }
    .like-button:hover {
      background: #e0e7ff;
      box-shadow: none;
      transform: translateY(-1px);
    }
    .like-button.liked {
      background: #fee2e2;
      color: #b91c1c;
    }
    .comments-panel {
      margin-top: 8px;
      border-top: 1px solid #e5e7eb;
      padding-top: 8px;
      display: none;
    }
    .comment-item {
      font-size: 13px;
      padding: 4px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    .comment-meta {
      color: #6b7280;
      font-size: 11px;
      margin-bottom: 2px;
    }
    .comment-text {
      white-space: pre-wrap;
    }
    .comments-list {
      max-height: 180px;
      overflow-y: auto;
      margin-bottom: 6px;
    }
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .list-box {
      border-radius: 12px;
      background: #f3f4f6;
      padding: 8px 10px;
      max-height: 140px;
      overflow-y: auto;
      font-size: 13px;
    }
    .list-box-title {
      font-size: 12px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 4px;
    }
    .list-item {
      padding: 2px 0;
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .avatar-wrapper {
      width: 64px;
      height: 64px;
      border-radius: 999px;
      overflow: hidden;
      background: #e5e7eb;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #9ca3af;
    }
    .avatar-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .profile-name {
      font-weight: 600;
      font-size: 16px;
    }
    .profile-email {
      font-size: 13px;
      color: #6b7280;
    }
    .avatar-form-row {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .avatar-form-row input[type="file"] {
      padding: 4px;
      font-size: 12px;
      background: transparent;
      border-radius: 999px;
      border: none;
      margin-bottom: 0;
    }
    .small-note {
      font-size: 11px;
      color: #9ca3af;
    }
    .edit-indicator {
      font-size: 12px;
      color: #92400e;
      background: #fef3c7;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å -->
  <div>
    <!-- –ë–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
    <div class="card" id="auth-card">
      <div class="header-row">
        <div>
          <h2>–ê–∫–∫–∞—É–Ω—Ç</h2>
          <div class="muted"> </div>
        </div>
      </div>

      <div id="auth-block">
        <h3 style="margin-bottom:6px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
        <form id="register-form">
          <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
          <input id="reg-username" autocomplete="off" required />

          <label>Email</label>
          <input id="reg-email" type="email" autocomplete="off" required />

          <label>–ü–∞—Ä–æ–ª—å</label>
          <input id="reg-password" type="password" required />

          <label>–ò–º—è</label>
          <input id="reg-first-name" autocomplete="off" />

          <label>–§–∞–º–∏–ª–∏—è</label>
          <input id="reg-last-name" autocomplete="off" />

          <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          <div id="register-status" class="status"></div>
        </form>

        <hr style="margin:16px -20px; border:none; border-top:1px solid #e5e7eb;" />

        <h3 style="margin-bottom:6px;">–õ–æ–≥–∏–Ω</h3>
        <form id="login-form">
          <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
          <input id="login-username" autocomplete="username" required />

          <label>–ü–∞—Ä–æ–ª—å</label>
          <input id="login-password" type="password" autocomplete="current-password" required />

          <div style="display:flex; gap:8px; margin-top:4px;">
            <button type="submit">–í–æ–π—Ç–∏</button>
          </div>

          <div id="login-status" class="status"></div>
        </form>
      </div>
    </div>

    <!-- –ë–ª–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
    <div class="card" id="profile-card" style="display:none; margin-top:16px;">
      <div class="header-row">
        <div>
          <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
        </div>
        <div class="pill" id="logged-in-pill">
          –í —Å–∏—Å—Ç–µ–º–µ: <strong id="profile-username-pill"></strong>
        </div>
      </div>

      <div class="profile-header">
        <div class="avatar-wrapper">
          <img id="avatar-img" alt="avatar" style="display:none;" />
          <span id="avatar-placeholder">üôÇ</span>
        </div>
        <div>
          <div class="profile-name" id="profile-username">‚Äî</div>
          <div class="profile-email" id="profile-email">‚Äî</div>
        </div>
      </div>

      <form id="avatar-form" class="avatar-form-row">
        <input id="avatar-file" type="file" accept="image/*" />
        <button type="submit" class="small">–û–±–Ω–æ–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
      </form>
      <div id="avatar-status" class="status"></div>
      <div class="small-note">
        –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.
      </div>

      <div class="two-column">
        <div class="list-box">
          <div class="list-box-title">–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏</div>
          <div id="following-list" class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
        </div>
        <div class="list-box">
          <div class="list-box-title">–ú–æ–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
          <div id="followers-list" class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; justify-content:flex-start;">
        <button type="button" class="secondary" id="logout-btn">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ø–æ—Å—Ç—ã -->
  <div class="right-column">
    <div class="card">
      <div class="header-row">
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <h2>–ü–æ—Å—Ç—ã</h2>
          <span id="edit-indicator" class="edit-indicator" style="display:none;">
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ <span id="edit-post-id-label"></span>
          </span>
        </div>
        <button type="button" class="secondary" id="refresh-posts-btn">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      </div>

      <form id="create-post-form">
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
        <input id="post-title" required />

        <label>–¢–µ–∫—Å—Ç</label>
        <textarea id="post-content" required></textarea>

        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <button type="submit" id="create-post-btn">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</button>
          <button type="button" class="secondary" id="cancel-edit-btn" style="display:none;">
            –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
          </button>
        </div>
        <div id="create-post-status" class="status"></div>
      </form>

      <hr style="margin:16px -20px; border:none; border-top:1px solid #e5e7eb;" />

      <div class="muted" style="margin-bottom:4px;">–°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤</div>
      <div id="posts-container" class="posts-list"></div>
    </div>
  </div>
</div>

<script>
  const API_BASE = ""; // —Ç–æ—Ç –∂–µ —Ö–æ—Å—Ç/–ø–æ—Ä—Ç, —á—Ç–æ –∏ –±—ç–∫
  let accessToken = null;
  let currentUsername = null;
  let currentEmail = null;
  let currentAvatarUrl = null; // data URL
  let editingPostId = null;

  function setStatus(id, text, ok = null) {
    const el = document.getElementById(id);
    el.textContent = text || "";
    el.classList.remove("ok", "err");
    if (ok === true) el.classList.add("ok");
    if (ok === false) el.classList.add("err");
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function formatDate(iso) {
    if (!iso) return "";
    try {
      const d = new Date(iso);
      return d.toLocaleString();
    } catch {
      return iso;
    }
  }

  async function apiFetch(path, options = {}) {
    const headers = options.headers ? { ...options.headers } : {};
    if (accessToken) {
      headers["Authorization"] = "Bearer " + accessToken;
    }
    return fetch(API_BASE + path, { ...options, headers });
  }

  // ---------- –ê–≤–∞—Ç–∞—Ä: —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ localStorage ----------
  function avatarStorageKey(username) {
    return "socialMiniAvatar_" + username;
  }

  function loadAvatarFromStorageFor(username) {
    if (!username) {
      currentAvatarUrl = null;
      return;
    }
    try {
      const stored = localStorage.getItem(avatarStorageKey(username));
      currentAvatarUrl = stored || null;
    } catch(e) {
      console.warn("Cannot access localStorage for avatar", e);
      currentAvatarUrl = null;
    }
  }

  function saveAvatarToStorageFor(username, dataUrl) {
    if (!username || !dataUrl) return;
    try {
      localStorage.setItem(avatarStorageKey(username), dataUrl);
    } catch(e) {
      console.warn("Cannot save avatar to localStorage", e);
    }
    currentAvatarUrl = dataUrl;
  }

  function applyAvatarToDOM() {
    const avatarImg = document.getElementById("avatar-img");
    const avatarPlaceholder = document.getElementById("avatar-placeholder");

    if (currentAvatarUrl) {
      avatarImg.src = currentAvatarUrl;
      avatarImg.style.display = "block";
      avatarPlaceholder.style.display = "none";
    } else {
      avatarImg.src = "";
      avatarImg.style.display = "none";
      avatarPlaceholder.style.display = "block";
    }
  }

  function updateLayoutByAuthState() {
    const authCard = document.getElementById("auth-card");
    const profileCard = document.getElementById("profile-card");

    if (accessToken && currentUsername) {
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å, —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—ã
      authCard.style.display = "none";
      profileCard.style.display = "block";

      document.getElementById("profile-username-pill").textContent = currentUsername || "";
      document.getElementById("profile-username").textContent = currentUsername || "‚Äî";
      document.getElementById("profile-email").textContent = currentEmail || "‚Äî";

      applyAvatarToDOM();
    } else {
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—ã, —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
      authCard.style.display = "block";
      profileCard.style.display = "none";

      setStatus("login-status", "", null);
      setStatus("register-status", "", null);
    }
  }

  async function loginAndInit(username, password) {
    const body = new URLSearchParams();
    body.append("username", username);
    body.append("password", password);

    const resp = await apiFetch("/auth/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body,
    });

    if (!resp.ok) {
      const text = await resp.text();
      throw new Error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + text);
    }

    const data = await resp.json();
    accessToken = data.access_token;
    currentUsername = username;

    // –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä –∏–∑ localStorage
    loadAvatarFromStorageFor(currentUsername);

    updateLayoutByAuthState();
    setStatus("login-status", "–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥", true);

    await loadPosts();
    await loadFollowInfo();
  }

  // ---------- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ----------
  document.getElementById("register-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    setStatus("register-status", "–û—Ç–ø—Ä–∞–≤–∫–∞...", null);

    const username = document.getElementById("reg-username").value.trim();
    const email = document.getElementById("reg-email").value.trim();
    const password = document.getElementById("reg-password").value;
    const first_name = document.getElementById("reg-first-name").value.trim() || null;
    const last_name = document.getElementById("reg-last-name").value.trim() || null;

    const payload = { username, email, password, first_name, last_name };

    try {
      const resp = await apiFetch("/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const text = await resp.text();
      if (!resp.ok) {
        setStatus("register-status", "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + text, false);
        return;
      }

      let data = null;
      try { data = JSON.parse(text); } catch {}

      setStatus(
        "register-status",
        data && data.username
          ? "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω: " + data.username + ". –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Ö–æ–¥..."
          : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω. –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Ö–æ–¥...",
        true
      );

      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º email –≤ –ø—Ä–æ—Ñ–∏–ª—å (–±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞)
      currentEmail = email;

      // –ê–≤—Ç–æ-–ª–æ–≥–∏–Ω –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      try {
        await loginAndInit(username, password);
      } catch (loginErr) {
        console.error(loginErr);
        setStatus("login-status", loginErr.message, false);
      }
    } catch (err) {
      console.error(err);
      setStatus("register-status", "–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: " + err.message, false);
    }
  });

  // ---------- –õ–æ–≥–∏–Ω / –ª–æ–≥–∞—É—Ç ----------
  document.getElementById("login-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    setStatus("login-status", "–í—Ö–æ–¥–∏–º...", null);

    const username = document.getElementById("login-username").value.trim();
    const password = document.getElementById("login-password").value;

    try {
      await loginAndInit(username, password);
    } catch (err) {
      console.error(err);
      setStatus("login-status", err.message, false);
    }
  });

  document.getElementById("logout-btn").addEventListener("click", () => {
    accessToken = null;
    currentUsername = null;
    currentEmail = null;
    currentAvatarUrl = null; // –Ω–æ –≤ localStorage –∞–≤–∞—Ç–∞—Ä –æ—Å—Ç–∞—ë—Ç—Å—è

    editingPostId = null;
    document.getElementById("post-title").value = "";
    document.getElementById("post-content").value = "";
    resetEditState();
    updateLayoutByAuthState();
    setStatus("login-status", "–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã", null);
    loadPosts();
  });

  // ---------- –ê–≤–∞—Ç–∞—Ä (—Ç–æ–ª—å–∫–æ —Ñ—Ä–æ–Ω—Ç, –Ω–æ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ localStorage) ----------
  document.getElementById("avatar-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    setStatus("avatar-status", "", null);

    if (!accessToken || !currentUsername) {
      setStatus("avatar-status", "–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.", false);
      return;
    }

    const fileInput = document.getElementById("avatar-file");
    if (!fileInput.files || fileInput.files.length === 0) {
      setStatus("avatar-status", "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.", false);
      return;
    }

    const file = fileInput.files[0];

    // —á–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ data URL –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    try {
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error || new Error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞"));
        reader.readAsDataURL(file);
      });

      saveAvatarToStorageFor(currentUsername, dataUrl);
      applyAvatarToDOM();
      setStatus("avatar-status", "–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ.", true);
    } catch (err) {
      console.error(err);
      setStatus("avatar-status", "–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: " + err.message, false);
    }
  });

  // ---------- –ü–æ—Å—Ç—ã –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ----------
  document.getElementById("refresh-posts-btn").addEventListener("click", loadPosts);

  document.getElementById("cancel-edit-btn").addEventListener("click", () => {
    editingPostId = null;
    document.getElementById("post-title").value = "";
    document.getElementById("post-content").value = "";
    resetEditState();
  });

  function resetEditState() {
    editingPostId = null;
    const btn = document.getElementById("create-post-btn");
    const cancelBtn = document.getElementById("cancel-edit-btn");
    const indicator = document.getElementById("edit-indicator");
    const label = document.getElementById("edit-post-id-label");

    btn.textContent = "–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç";
    cancelBtn.style.display = "none";
    indicator.style.display = "none";
    label.textContent = "";
  }

  document.getElementById("create-post-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    setStatus("create-post-status", "", null);

    if (!accessToken) {
      setStatus("create-post-status", "–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ (–Ω—É–∂–µ–Ω —Ç–æ–∫–µ–Ω)", false);
      return;
    }

    const title = document.getElementById("post-title").value.trim();
    const content = document.getElementById("post-content").value.trim();

    if (!title || !content) {
      setStatus("create-post-status", "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç", false);
      return;
    }

    const payload = { title, content };

    try {
      let resp;
      if (editingPostId) {
        resp = await apiFetch("/posts/" + editingPostId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      } else {
        resp = await apiFetch("/posts/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }

      const text = await resp.text();
      if (!resp.ok) {
        setStatus(
          "create-post-status",
          (editingPostId ? "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: " : "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ") + text,
          false
        );
        return;
      }

      setStatus(
        "create-post-status",
        editingPostId ? "–ü–æ—Å—Ç –æ–±–Ω–æ–≤–ª—ë–Ω" : "–ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω",
        true
      );
      document.getElementById("post-title").value = "";
      document.getElementById("post-content").value = "";
      resetEditState();
      loadPosts();
    } catch (err) {
      console.error(err);
      setStatus("create-post-status", "–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: " + err.message, false);
    }
  });

  async function loadPosts() {
    const container = document.getElementById("posts-container");
    container.innerHTML = "<div class='muted'>–ó–∞–≥—Ä—É–∑–∫–∞...</div>";

    try {
      const resp = await apiFetch("/posts/", { method: "GET" });
      if (!resp.ok) {
        const text = await resp.text();
        container.innerHTML = "<div class='status err'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤: " + text + "</div>";
        return;
      }
      const data = await resp.json();
      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = "<div class='muted'>–ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>";
        return;
      }

      container.innerHTML = "";
      data.forEach((post) => {
        const div = document.createElement("div");
        div.className = "post-card";

        const created = post.created_at ? formatDate(post.created_at) : "";
        const owner = post.owner_id != null ? `owner_id: ${post.owner_id}` : "";

        div.innerHTML = `
          <div class="post-title">${escapeHtml(post.title || "")}</div>
          <div class="post-meta">
            <span>#${post.id}</span>
            ${created ? `<span>¬∑ ${created}</span>` : ""}
            ${owner ? `<span>¬∑ ${owner}</span>` : ""}
          </div>
          <div class="post-content">${escapeHtml(post.content || "")}</div>
          <div class="post-actions">
            <button type="button" class="secondary small" data-action="open">–û—Ç–∫—Ä—ã—Ç—å</button>
            <button type="button" class="secondary small" data-action="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button type="button" class="danger small" data-action="delete">–£–¥–∞–ª–∏—Ç—å</button>
            <button type="button" class="like-button small" data-action="like-toggle">
              ‚ù§Ô∏è <span data-role="likes-count">0</span>
            </button>
            <button type="button" class="secondary small" data-action="toggle-comments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
            ${post.owner_id ? `<button type="button" class="secondary small" data-action="follow">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∞–≤—Ç–æ—Ä–∞</button>` : ""}
          </div>
          <div class="comments-panel" data-role="comments-panel">
            <div class="comments-list" data-role="comments-list">
              <div class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</div>
            </div>
            <div data-role="comment-form">
              <textarea data-role="comment-input" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
              <button type="button" class="small" data-action="send-comment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
          </div>
        `;

        const commentsPanel = div.querySelector("[data-role='comments-panel']");
        const commentsList = div.querySelector("[data-role='comments-list']");
        const commentInput = div.querySelector("[data-role='comment-input']");
        const likeButton = div.querySelector(".like-button");

        const btns = div.querySelectorAll("button");
        btns.forEach((btn) => {
          const action = btn.dataset.action;
          btn.addEventListener("click", () => {
            handlePostAction({
              action,
              post,
              likeButton,
              commentsPanel,
              commentsList,
              commentInput,
            });
          });
        });

        container.appendChild(div);
        refreshLikesCount(post.id, likeButton);
      });
    } catch (err) {
      console.error(err);
      container.innerHTML = "<div class='status err'>–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: " + err.message + "</div>";
    }
  }

  async function handlePostAction(ctx) {
    const { action, post, likeButton, commentsPanel, commentsList, commentInput } = ctx;
    if (!post || !post.id) return;

    if (action === "open") {
      document.getElementById("post-title").value = post.title || "";
      document.getElementById("post-content").value = post.content || "";
      return;
    }

    if (action === "edit") {
      if (!accessToken) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ (–Ω—É–∂–µ–Ω —Ç–æ–∫–µ–Ω).");
        return;
      }
      editingPostId = post.id;
      document.getElementById("post-title").value = post.title || "";
      document.getElementById("post-content").value = post.content || "";

      const btn = document.getElementById("create-post-btn");
      const cancelBtn = document.getElementById("cancel-edit-btn");
      const indicator = document.getElementById("edit-indicator");
      const label = document.getElementById("edit-post-id-label");

      btn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
      cancelBtn.style.display = "inline-flex";
      indicator.style.display = "inline-flex";
      label.textContent = "#" + post.id;
      return;
    }

    if (action === "delete") {
      if (!accessToken) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ (–Ω—É–∂–µ–Ω —Ç–æ–∫–µ–Ω).");
        return;
      }
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç #" + post.id + "?")) return;
      try {
        const resp = await apiFetch("/posts/" + post.id, { method: "DELETE" });
        if (!resp.ok) {
          const text = await resp.text();
          alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + text);
        } else {
          if (editingPostId === post.id) {
            resetEditState();
            document.getElementById("post-title").value = "";
            document.getElementById("post-content").value = "";
          }
          loadPosts();
        }
      } catch (err) {
        alert("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: " + err.message);
      }
      return;
    }

    if (action === "like-toggle") {
      if (!accessToken) {
        alert("–ù—É–∂–µ–Ω –≤—Ö–æ–¥, —á—Ç–æ–±—ã –ª–∞–π–∫–∞—Ç—å.");
        return;
      }
      try {
        const resp = await apiFetch("/posts/" + post.id + "/like", { method: "POST" });
        const text = await resp.text();
        if (!resp.ok) {
          alert("–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞: " + text);
        } else {
          refreshLikesCount(post.id, likeButton);
        }
      } catch (err) {
        alert("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: " + err.message);
      }
      return;
    }

    if (action === "toggle-comments") {
      if (commentsPanel.style.display === "block") {
        commentsPanel.style.display = "none";
      } else {
        commentsPanel.style.display = "block";
        loadCommentsForPost(post.id, commentsList);
      }
      return;
    }

    if (action === "send-comment") {
      if (!accessToken) {
        alert("–ù—É–∂–µ–Ω –≤—Ö–æ–¥, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.");
        return;
      }
      const text = (commentInput.value || "").trim();
      if (!text) {
        alert("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º.");
        return;
      }
      try {
        const resp = await apiFetch("/posts/" + post.id + "/comments", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: text }),
        });
        const body = await resp.text();
        if (!resp.ok) {
          alert("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: " + body);
        } else {
          commentInput.value = "";
          loadCommentsForPost(post.id, commentsList);
        }
      } catch (err) {
        alert("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: " + err.message);
      }
      return;
    }

    if (action === "follow") {
      if (!accessToken) {
        alert("–ù—É–∂–µ–Ω –≤—Ö–æ–¥, —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è.");
        return;
      }
      if (!post.owner_id) {
        alert("–£ –ø–æ—Å—Ç–∞ –Ω–µ—Ç owner_id, –Ω–µ –Ω–∞ –∫–æ–≥–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è.");
        return;
      }
      try {
        const resp = await apiFetch("/users/" + post.owner_id + "/follow", {
          method: "POST",
        });
        const body = await resp.text();
        if (!resp.ok) {
          alert("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏: " + body);
        } else {
          loadFollowInfo();
          alert("–ü–æ–¥–ø–∏—Å–∫–∞/–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–≤—è–∑–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.");
        }
      } catch (err) {
        alert("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: " + err.message);
      }
      return;
    }
  }

  async function refreshLikesCount(postId, likeButton) {
    if (!likeButton) return;
    const countEl = likeButton.querySelector("[data-role='likes-count']");
    if (!countEl) return;
    try {
      const resp = await apiFetch("/posts/" + postId + "/likes", { method: "GET" });
      if (!resp.ok) {
        countEl.textContent = "?";
        return;
      }
      const data = await resp.json();
      countEl.textContent = data.likes_count ?? 0;
    } catch (err) {
      console.error(err);
      countEl.textContent = "?";
    }
  }

  // ---------- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ----------
  async function loadCommentsForPost(postId, listEl) {
    listEl.innerHTML = "<div class='muted'>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</div>";
    try {
      const resp = await apiFetch("/posts/" + postId + "/comments", { method: "GET" });
      if (!resp.ok) {
        const text = await resp.text();
        listEl.innerHTML = "<div class='status err'>–û—à–∏–±–∫–∞: " + text + "</div>";
        return;
      }
      const data = await resp.json();
      if (!Array.isArray(data) || data.length === 0) {
        listEl.innerHTML = "<div class='muted'>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>";
        return;
      }
      listEl.innerHTML = "";
      data.forEach((c) => {
        const div = document.createElement("div");
        div.className = "comment-item";
        div.innerHTML = `
          <div class="comment-meta">
            #${c.id}
            ${c.user_id ? ` ¬∑ user_id: ${c.user_id}` : ""}
            ${c.created_at ? " ¬∑ " + formatDate(c.created_at) : ""}
          </div>
          <div class="comment-text">${escapeHtml(c.content || "")}</div>
        `;
        listEl.appendChild(div);
      });
    } catch (err) {
      console.error(err);
      listEl.innerHTML = "<div class='status err'>–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: " + err.message + "</div>";
    }
  }

  // ---------- –ü–æ–¥–ø–∏—Å–∫–∏ ----------
  async function loadFollowInfo() {
    const followingEl = document.getElementById("following-list");
    const followersEl = document.getElementById("followers-list");

    followingEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    followersEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    if (!accessToken) {
      followingEl.textContent = "–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥.";
      followersEl.textContent = "–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥.";
      return;
    }

    try {
      const [followingResp, followersResp] = await Promise.all([
        apiFetch("/users/me/following", { method: "GET" }),
        apiFetch("/users/me/followers", { method: "GET" }),
      ]);

      if (followingResp.ok) {
        const data = await followingResp.json();
        if (!Array.isArray(data) || data.length === 0) {
          followingEl.textContent = "–ü–æ–∫–∞ –Ω–∏ –Ω–∞ –∫–æ–≥–æ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã.";
        } else {
          followingEl.innerHTML = "";
          data.forEach((f) => {
            const item = document.createElement("div");
            item.className = "list-item";
            item.textContent = `user_id: ${f.user_id}`;
            followingEl.appendChild(item);
          });
        }
      } else {
        followingEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.";
      }

      if (followersResp.ok) {
        const data = await followersResp.json();
        if (!Array.isArray(data) || data.length === 0) {
          followersEl.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.";
        } else {
          followersEl.innerHTML = "";
          data.forEach((f) => {
            const item = document.createElement("div");
            item.className = "list-item";
            item.textContent = `follower_id: ${f.follower_id}`;
            followersEl.appendChild(item);
          });
        }
      } else {
        followersEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.";
      }
    } catch (err) {
      console.error(err);
      followingEl.textContent = "–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞.";
      followersEl.textContent = "–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞.";
    }
  }

  // ---------- –°—Ç–∞—Ä—Ç ----------
  updateLayoutByAuthState();
  loadPosts();
</script>
</body>
</html>